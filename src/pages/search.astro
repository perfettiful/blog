---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';

const posts = (await getCollection('blog', ({ data }) => !data.draft))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Get all unique tags with counts
const allTags = [...new Set(posts.flatMap(post => post.data.tags))].sort();
const tagCounts = allTags.reduce((acc, tag) => {
  acc[tag] = posts.filter(post => post.data.tags.includes(tag)).length;
  return acc;
}, {} as Record<string, number>);

// Create search index data
const searchData = posts.map(post => ({
  title: post.data.title,
  description: post.data.description,
  tags: post.data.tags,
  slug: post.id,
  date: post.data.date.toISOString(),
  heroImage: post.data.heroImage || null,
}));
---

<BaseLayout title="Search" description="Search all blog posts.">
  <Header />

  <main class="flex-1" transition:name="main" transition:animate="none">
    <div class="max-w-3xl mx-auto px-4 py-12">
      <header class="mb-8">
        <h1 class="text-4xl font-bold text-zinc-900 dark:text-zinc-100 mb-4">
          Search
        </h1>
        <p class="text-xl text-zinc-600 dark:text-zinc-400">
          Find posts by title, description, or tags.
        </p>
      </header>

      <!-- Search Input -->
      <div class="relative mb-6">
        <input
          type="text"
          id="search-input"
          placeholder="Type to search..."
          autocomplete="off"
          class="w-full px-5 py-4 pl-12 rounded-xl border border-primary-200/40 dark:border-primary-900/40 bg-white dark:bg-zinc-900/60 text-zinc-900 dark:text-zinc-100 placeholder-zinc-400 dark:placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-primary-500/50 focus:border-primary-500 transition-all duration-200"
        />
        <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </div>

      <!-- Tags Filter -->
      <div class="mb-8">
        <p class="text-sm text-zinc-500 dark:text-zinc-400 mb-3">Filter by tag:</p>
        <div class="flex flex-wrap gap-2">
          <button
            id="clear-tag"
            class="hidden px-3 py-1.5 text-sm rounded-lg bg-zinc-200 dark:bg-zinc-700 text-zinc-700 dark:text-zinc-300 hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-all duration-200"
          >
            ✕ Clear
          </button>
          {allTags.map((tag) => (
            <button
              data-tag={tag}
              class="tag-btn px-3 py-1.5 text-sm rounded-lg bg-primary-100/60 dark:bg-primary-900/30 text-primary-800 dark:text-primary-200 hover:bg-primary-200 dark:hover:bg-primary-800/40 transition-all duration-200"
            >
              {tag}
              <span class="ml-1 text-zinc-500 dark:text-zinc-400">({tagCounts[tag]})</span>
            </button>
          ))}
        </div>
      </div>

      <!-- Results -->
      <div id="search-results" class="space-y-4">
        <!-- Initial content will be replaced by JS -->
      </div>
    </div>
  </main>

  <Footer />
</BaseLayout>

<script define:vars={{ searchData }}>
  const input = document.getElementById('search-input');
  const resultsContainer = document.getElementById('search-results');
  const tagButtons = document.querySelectorAll('.tag-btn');
  const clearBtn = document.getElementById('clear-tag');

  let activeTag = null;

  function formatDate(dateStr) {
    return new Date(dateStr).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  }

  function renderResults(results, showHeader = null) {
    const header = showHeader ? `<p class="text-sm text-zinc-500 dark:text-zinc-400 mb-4">${showHeader}</p>` : '';
    
    resultsContainer.innerHTML = header + results.map(post => `
      <a href="/blog/${post.slug}" class="block group">
        <div class="flex gap-4 p-5 rounded-xl border border-primary-200/30 dark:border-primary-900/30 bg-white/80 dark:bg-zinc-900/60 hover:border-primary-400/50 dark:hover:border-primary-700/50 hover:shadow-lg hover:-translate-y-0.5 transition-all duration-200">
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 mb-2 flex-wrap">
              <time class="text-sm text-zinc-500 dark:text-zinc-400">${formatDate(post.date)}</time>
              ${post.tags.length ? `<span class="text-zinc-300 dark:text-zinc-600">·</span>` : ''}
              ${post.tags.map(tag => `<span class="text-xs text-primary-600 dark:text-primary-400">#${tag}</span>`).join('')}
            </div>
            <h2 class="text-lg font-bold text-zinc-900 dark:text-zinc-100 group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors duration-200 line-clamp-1">${post.title}</h2>
            <p class="mt-1 text-zinc-600 dark:text-zinc-400 text-sm line-clamp-2">${post.description}</p>
          </div>
        </div>
      </a>
    `).join('');
  }

  function search() {
    const query = input?.value?.toLowerCase()?.trim() || '';
    
    // Show recent posts if no query and no tag filter
    if (!query && !activeTag) {
      const recentPosts = searchData.slice(0, 5);
      renderResults(recentPosts, 'Recent posts:');
      return;
    }

    let results = searchData;

    // Filter by active tag first
    if (activeTag) {
      results = results.filter(post => 
        post.tags.some(tag => tag.toLowerCase() === activeTag.toLowerCase())
      );
    }

    // Then filter by search query
    if (query) {
      results = results.filter(post => 
        post.title.toLowerCase().includes(query) ||
        post.description.toLowerCase().includes(query) ||
        post.tags.some(tag => tag.toLowerCase().includes(query))
      );
    }

    if (results.length === 0) {
      const filterDesc = activeTag 
        ? `No posts found${query ? ` for "${query}"` : ''} in #${activeTag}`
        : `No posts found for "${query}"`;
      resultsContainer.innerHTML = `
        <p class="text-zinc-500 dark:text-zinc-400 text-center py-8">
          ${filterDesc}
        </p>
      `;
      return;
    }

    const header = activeTag ? `Showing ${results.length} post${results.length === 1 ? '' : 's'} in #${activeTag}:` : null;
    renderResults(results, header);
  }

  function setActiveTag(tag) {
    activeTag = tag;
    
    // Update button states
    tagButtons.forEach(btn => {
      const btnTag = btn.getAttribute('data-tag');
      if (btnTag === tag) {
        btn.classList.add('ring-2', 'ring-primary-500', 'ring-offset-2', 'ring-offset-surface', 'dark:ring-offset-surface-dark');
      } else {
        btn.classList.remove('ring-2', 'ring-primary-500', 'ring-offset-2', 'ring-offset-surface', 'dark:ring-offset-surface-dark');
      }
    });

    // Show/hide clear button
    clearBtn?.classList.toggle('hidden', !tag);
    
    search();
  }

  // Tag button clicks
  tagButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const tag = btn.getAttribute('data-tag');
      setActiveTag(activeTag === tag ? null : tag);
    });
  });

  // Clear button
  clearBtn?.addEventListener('click', () => setActiveTag(null));

  // Search input
  input?.addEventListener('input', search);
  
  // Show recent posts on load
  search();
  
  // Focus input on page load
  input?.focus();
</script>
